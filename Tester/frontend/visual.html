<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmartBin AI - Visual Only</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen p-6">
      <div class="mx-auto max-w-6xl">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight">SmartBin AI - Visual Only</h1>
            <p class="text-sm text-slate-400">Server webcam + Roboflow detection</p>
          </div>
          <div class="text-xs text-slate-400">Status: <span id="statusText" class="font-semibold text-emerald-400">READY</span></div>
        </div>

        <div class="mt-3 flex flex-wrap gap-3 text-xs text-slate-400">
          <a class="hover:text-slate-200" href="av.html">Audio + Visual</a>
          <a class="hover:text-slate-200" href="audio.html">Audio Only</a>
          <a class="hover:text-slate-200" href="visual.html">Visual Only</a>
          <a class="hover:text-slate-200" href="dashboard.html">Dashboard</a>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-xl">
            <div class="relative overflow-hidden rounded-xl border border-slate-800">
              <img id="stream" class="h-[420px] w-full bg-black object-cover" alt="Server stream" />
              <div class="absolute left-3 top-3 rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-300" id="statusBadge">READY</div>
            </div>

            <div class="mt-4 flex flex-wrap gap-3">
              <button id="captureBtn" class="rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-xs text-slate-200 hover:bg-slate-700">Capture</button>
              <button id="autoBtn" class="rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-xs text-slate-200 hover:bg-slate-700">Auto Detect</button>
              <div class="text-xs text-slate-400 flex items-center">Interval: 2s</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-xl">
            <div class="flex items-center justify-between">
              <h2 class="text-sm font-semibold text-slate-200">Visual Detection Log</h2>
              <button id="clearBtn" class="rounded-lg border border-slate-700 bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Clear</button>
            </div>

            <div class="mt-3 overflow-hidden rounded-xl border border-slate-800">
              <table class="w-full text-left text-xs">
                <thead class="bg-slate-900 text-slate-400">
                  <tr>
                    <th class="px-3 py-2">Time</th>
                    <th class="px-3 py-2">Label</th>
                    <th class="px-3 py-2">Confidence</th>
                    <th class="px-3 py-2">Latency</th>
                  </tr>
                </thead>
                <tbody id="logBody" class="divide-y divide-slate-800 bg-slate-950"></tbody>
              </table>
            </div>

            <div class="mt-3 text-xs text-slate-500" id="lastEvent">Waiting for capture...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const streamImg = document.getElementById("stream");
      const statusText = document.getElementById("statusText");
      const statusBadge = document.getElementById("statusBadge");
      const captureBtn = document.getElementById("captureBtn");
      const autoBtn = document.getElementById("autoBtn");
      const clearBtn = document.getElementById("clearBtn");
      const logBody = document.getElementById("logBody");
      const lastEvent = document.getElementById("lastEvent");

      const AUTO_INTERVAL_MS = 2000;
      let autoTimer = null;
      let isDetecting = false;

      function apiBase() {
        return window.location.origin && window.location.origin.startsWith("http")
          ? window.location.origin
          : "http://localhost:8000";
      }

      function setStatus(text, kind) {
        statusText.textContent = text;
        statusBadge.textContent = text;
        statusText.className = "font-semibold";
        statusBadge.className = "absolute left-3 top-3 rounded-full px-3 py-1 text-xs font-semibold";
        if (kind === "detecting") {
          statusText.classList.add("text-amber-400");
          statusBadge.classList.add("bg-amber-400/20", "text-amber-300");
        } else if (kind === "error") {
          statusText.classList.add("text-rose-400");
          statusBadge.classList.add("bg-rose-400/20", "text-rose-300");
        } else {
          statusText.classList.add("text-emerald-400");
          statusBadge.classList.add("bg-emerald-500/20", "text-emerald-300");
        }
      }

      function setStreamSrc() {
        streamImg.src = `${apiBase()}/visual/stream`;
      }

      function prependRow(entry) {
        const tr = document.createElement("tr");
        tr.className = "text-slate-200";
        const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : "-";
        const conf = entry.visual_confidence !== undefined ? Number(entry.visual_confidence).toFixed(2) : "0.00";
        const elapsed = entry.elapsed_ms !== undefined ? `${entry.elapsed_ms} ms` : "-";
        tr.innerHTML = `
          <td class="px-3 py-2 text-slate-400">${ts}</td>
          <td class="px-3 py-2">${entry.visual_label || "-"}</td>
          <td class="px-3 py-2">${conf}</td>
          <td class="px-3 py-2 text-slate-400">${elapsed}</td>
        `;
        if (logBody.firstChild) {
          logBody.insertBefore(tr, logBody.firstChild);
        } else {
          logBody.appendChild(tr);
        }
      }

      async function runDetect() {
        if (isDetecting) return;
        isDetecting = true;
        setStatus("DETECTING...", "detecting");
        try {
          const res = await fetch(`${apiBase()}/api/visual-detect-server`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          prependRow(data);
          lastEvent.textContent = `Last: ${data.visual_label} (${(data.visual_confidence || 0).toFixed(2)})`;
          setStatus("READY", "ok");
        } catch (err) {
          setStatus("BACKEND ERROR", "error");
          console.error(err);
        } finally {
          isDetecting = false;
        }
      }

      function toggleAuto() {
        if (autoTimer) {
          clearInterval(autoTimer);
          autoTimer = null;
          autoBtn.textContent = "Auto Detect";
          setStatus("READY", "ok");
          return;
        }
        autoBtn.textContent = "Stop Auto";
        runDetect();
        autoTimer = setInterval(runDetect, AUTO_INTERVAL_MS);
      }

      clearBtn.addEventListener("click", () => {
        logBody.innerHTML = "";
        lastEvent.textContent = "Log cleared.";
      });

      captureBtn.addEventListener("click", runDetect);
      autoBtn.addEventListener("click", toggleAuto);

      setStreamSrc();
    </script>
  </body>
</html>
