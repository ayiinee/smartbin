<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmartBin AI - Audio Only</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen p-6">
      <div class="mx-auto max-w-6xl">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight">SmartBin AI - Audio Only</h1>
            <p class="text-sm text-slate-400">Microphone anomaly vs bottle detection</p>
          </div>
          <div class="text-xs text-slate-400">Status: <span id="statusText" class="font-semibold text-emerald-400">READY</span></div>
        </div>

        <div class="mt-3 flex flex-wrap gap-3 text-xs text-slate-400">
          <a class="hover:text-slate-200" href="av.html">Audio + Visual</a>
          <a class="hover:text-slate-200" href="audio.html">Audio Only</a>
          <a class="hover:text-slate-200" href="visual.html">Visual Only</a>
          <a class="hover:text-slate-200" href="dashboard.html">Dashboard</a>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-xl">
            <div class="rounded-xl border border-slate-800 p-4">
              <div class="text-sm text-slate-300">Live audio monitor</div>
              <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2">
                <div>
                  <label class="text-xs text-slate-400">Volume threshold</label>
                  <input id="threshold" type="range" min="0.05" max="0.9" step="0.01" value="0.4" class="w-full" />
                  <div class="mt-1 text-xs text-slate-400">Current: <span id="thresholdValue">0.40</span></div>
                </div>
                <div>
                  <label class="text-xs text-slate-400">Live RMS</label>
                  <div class="mt-2 h-2 w-full rounded-full bg-slate-800">
                    <div id="rmsBar" class="h-2 rounded-full bg-emerald-400" style="width: 0%"></div>
                  </div>
                  <div class="mt-1 text-xs text-slate-400">RMS: <span id="rmsValue">0.000</span></div>
                </div>
              </div>

              <div class="mt-4 flex items-center justify-between text-xs text-slate-400">
                <div>Trigger debounce: <span class="font-semibold text-slate-200">3000ms</span></div>
                <div>Audio record: <span class="font-semibold text-slate-200">2000ms</span></div>
              </div>

              <div class="mt-4 flex flex-wrap gap-3">
                <button id="startBtn" class="rounded-lg border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20">Start</button>
                <button id="stopBtn" class="rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-xs text-slate-200 hover:bg-slate-700">Stop</button>
              </div>
            </div>

            <div class="mt-4 rounded-xl border border-slate-800 p-4">
              <div class="text-sm text-slate-300">Test audio file</div>
              <div class="mt-3 flex flex-wrap items-center gap-3">
                <input id="audioFileInput" type="file" accept="audio/*" class="text-xs text-slate-300 file:mr-3 file:rounded-lg file:border-0 file:bg-slate-800 file:px-3 file:py-2 file:text-xs file:text-slate-200 hover:file:bg-slate-700" />
                <button id="fileTestBtn" class="rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-xs text-slate-200 hover:bg-slate-700">Classify File</button>
              </div>
              <div class="mt-2 text-xs text-slate-500" id="fileStatus">Choose an audio file to test.</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-xl">
            <div class="flex items-center justify-between">
              <h2 class="text-sm font-semibold text-slate-200">Audio Detection Log</h2>
              <button id="clearBtn" class="rounded-lg border border-slate-700 bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Clear</button>
            </div>

            <div class="mt-3 overflow-hidden rounded-xl border border-slate-800">
              <table class="w-full text-left text-xs">
                <thead class="bg-slate-900 text-slate-400">
                  <tr>
                    <th class="px-3 py-2">Time</th>
                    <th class="px-3 py-2">Label</th>
                    <th class="px-3 py-2">Confidence</th>
                    <th class="px-3 py-2">Latency</th>
                  </tr>
                </thead>
                <tbody id="logBody" class="divide-y divide-slate-800 bg-slate-950"></tbody>
              </table>
            </div>

            <div class="mt-3 text-xs text-slate-500" id="lastEvent">Waiting for first detection...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const statusText = document.getElementById("statusText");
      const thresholdEl = document.getElementById("threshold");
      const thresholdValue = document.getElementById("thresholdValue");
      const rmsBar = document.getElementById("rmsBar");
      const rmsValue = document.getElementById("rmsValue");
      const logBody = document.getElementById("logBody");
      const lastEvent = document.getElementById("lastEvent");
      const clearBtn = document.getElementById("clearBtn");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const audioFileInput = document.getElementById("audioFileInput");
      const fileTestBtn = document.getElementById("fileTestBtn");
      const fileStatus = document.getElementById("fileStatus");

      const DETECT_MS = 2000;
      const DEBOUNCE_MS = 3000;

      let mediaStream = null;
      let audioContext = null;
      let analyser = null;
      let rafId = null;
      let lastTrigger = 0;
      let isDetecting = false;
      let isListening = false;

      function setStatus(text, kind) {
        statusText.textContent = text;
        statusText.className = "font-semibold";
        if (kind === "detecting") {
          statusText.classList.add("text-amber-400");
        } else if (kind === "error") {
          statusText.classList.add("text-rose-400");
        } else {
          statusText.classList.add("text-emerald-400");
        }
      }

      function updateThresholdLabel() {
        thresholdValue.textContent = Number(thresholdEl.value).toFixed(2);
      }

      thresholdEl.addEventListener("input", updateThresholdLabel);
      updateThresholdLabel();

      clearBtn.addEventListener("click", () => {
        logBody.innerHTML = "";
        lastEvent.textContent = "Log cleared.";
      });

      function computeRms() {
        const buffer = new Uint8Array(analyser.fftSize);
        analyser.getByteTimeDomainData(buffer);
        let sumSq = 0;
        for (let i = 0; i < buffer.length; i++) {
          const v = (buffer[i] - 128) / 128;
          sumSq += v * v;
        }
        return Math.sqrt(sumSq / buffer.length);
      }

      function pickMimeType() {
        const candidates = [
          "audio/webm;codecs=opus",
          "audio/webm",
          "audio/ogg;codecs=opus",
          "audio/ogg",
        ];
        for (const t of candidates) {
          if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
            return t;
          }
        }
        return "";
      }

      function apiBase() {
        return window.location.origin && window.location.origin.startsWith("http")
          ? window.location.origin
          : "http://localhost:8000";
      }

      async function startStreams() {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
            },
          });
        } catch (err) {
          setStatus("PERMISSION ERROR", "error");
          console.error(err);
          return;
        }

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        await audioContext.resume();
        const source = audioContext.createMediaStreamSource(mediaStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);

        isListening = true;
        loop();
        loadRecentLogs();
      }

      function loop() {
        if (!analyser || !isListening) return;
        const rms = computeRms();
        rmsValue.textContent = rms.toFixed(3);
        const pct = Math.min(100, Math.max(0, (rms / 0.9) * 100));
        rmsBar.style.width = `${pct}%`;

        const threshold = Number(thresholdEl.value);
        const now = performance.now();
        if (!isDetecting && rms >= threshold && now - lastTrigger > DEBOUNCE_MS) {
          lastTrigger = now;
          runDetection();
        }

        rafId = requestAnimationFrame(loop);
      }

      async function runDetection() {
        if (!mediaStream) return;
        isDetecting = true;
        setStatus("DETECTING...", "detecting");

        const audioStream = new MediaStream(mediaStream.getAudioTracks());
        const mimeType = pickMimeType();
        const chunks = [];
        let recorder;

        try {
          recorder = new MediaRecorder(audioStream, mimeType ? { mimeType } : undefined);
        } catch (err) {
          setStatus("RECORDER ERROR", "error");
          console.error(err);
          isDetecting = false;
          return;
        }

        const audioBlob = await new Promise((resolve) => {
          recorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) chunks.push(e.data);
          };
          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: recorder.mimeType || "audio/webm" });
            resolve(blob);
          };
          recorder.start();
          setTimeout(() => recorder.stop(), DETECT_MS);
        });
        if (!audioBlob || audioBlob.size === 0) {
          setStatus("RECORDER ERROR", "error");
          console.warn("Captured audio blob is empty.");
          isDetecting = false;
          return;
        }

        try {
          const formData = new FormData();
          formData.happend("file", audioBlob, "audio.webm");

          const res = await fetch(`${apiBase()}/predict-audio`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          prependRow(data);
          lastEvent.textContent = `Last: ${data.label} (${(data.confidence_score || 0).toFixed(2)})`;
          setStatus("MONITORING", "ok");
        } catch (err) {
          setStatus("BACKEND ERROR", "error");
          console.error(err);
        } finally {
          isDetecting = false;
        }
      }

      async function handleStart() {
        if (!mediaStream) {
          await startStreams();
        } else if (!isListening) {
          isListening = true;
          loop();
        }
        setStatus("MONITORING", "ok");
        if (!isDetecting) {
          runDetection();
        }
      }

      function handleStop() {
        isListening = false;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaShbbbtream = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        analyser = null;
        setStatus("READY", "ok");
      }

      function prependRow(entry) {
        const tr = document.createElement("tr");
        tr.className = "text-slate-200";
        const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : "-";
        const conf = entry.confidence_score !== undefined ? Number(entry.confidence_score).toFixed(2) : "0.00";
        const elapsed = entry.elapsed_ms !== undefined ? `${entry.elapsed_ms} ms` : "-";
        tr.innerHTML = `
          <td class="px-3 py-2 text-slate-400">${ts}</td>
          <td class="px-3 py-2">${entry.label || "-"}</td>
          <td class="px-3 py-2">${conf}</td>
          <td class="px-3 py-2 text-slate-400">${elapsed}</td>
        `;
        if (logBody.firstChild) {
          logBody.insertBefore(tr, logBody.firstChild);
        } else {
          logBody.appendChild(tr);
        }
      }

      async function loadRecentLogs() {
        try {
          const res = await fetch(`${apiBase()}/api/stats`);
          if (!res.ok) return;
          const data = await res.json();
          const recent = data.recent_activity || [];
          if (recent.length) {
            recent.forEach((r) => {
              prependRow({
                label: r.detected_label,
                confidence_score: r.confidence_score,
                timestamp: r.timestamp,
              });
            });
            lastEvent.textContent = "Loaded recent audio logs.";
          }
        } catch (err) {
          console.warn(err);
        }
      }

      async function handleFileTest() {
        const file = audioFileInput.files && audioFileInput.files[0];
        if (!file) {
          fileStatus.textContent = "Please select an audio file first.";
          return;
        }
        fileStatus.textContent = "Uploading and processing...";
        try {
          const formData = new FormData();
          formData.append("file", file, file.name || "audio.wav");
          const res = await fetch(`${apiBase()}/predict-audio`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          prependRow(data);
          lastEvent.textContent = `File: ${data.label} (${(data.confidence_score || 0).toFixed(2)})`;
          fileStatus.textContent = "File classified successfully.";
        } catch (err) {
          fileStatus.textContent = "Failed to classify file.";
          console.error(err);
        }
      }

      startBtn.addEventListener("click", handleStart);
      stopBtn.addEventListener("click", handleStop);
      fileTestBtn.addEventListener("click", handleFileTest);
    </script>
  </body>
</html>
